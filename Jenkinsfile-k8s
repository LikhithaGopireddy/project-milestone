// version
def version = "0.${env.BUILD_NUMBER}"

pipeline {
  agent any

   environment {
    AWS_REGION = "eu-central-1"
    EKS_CLUSTER = "quantum-eks-cluster"
  } 

  stages {
    stage('Prepare') {
      steps {
        checkout scm   // optional ‚Äî ensures workspace matches Jenkinsfile checkout
      }
    }

    stage('Build') {
      steps {
        // requires node & npm on the agent
        sh 'npm ci'
        sh 'npm run build'
      }
    }

    stage('Test / Lint') {
      steps {
        sh 'npm run lint || true'
      }
    }

    stage('Connect to EKS') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-creds'
        ]]) {
          sh """
            aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER}
            kubectl get nodes
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        sh """
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
        """
      }
    }
  }

  post {
    success { echo "üéâ Deployment successful ‚Äî pictogram running (image: my-pictogram-app:${version})" }
    failure { echo "‚ùå Pipeline failed ‚Äî check logs." }
    always  { echo "Pipeline finished for build ${env.BUILD_NUMBER}" }
  }
}
