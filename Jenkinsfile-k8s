// version
def version = "0.${env.BUILD_NUMBER}"

pipeline {
  agent any

   environment {
    AWS_REGION = "us-east-1"
    EKS_CLUSTER = "pictogram-eks-cluster"
  } 

  stages {
    stage('Prepare') {
      steps {
        checkout scm   // optional ‚Äî ensures workspace matches Jenkinsfile checkout
      }
    }


    stage('Connect to EKS') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-creds'
        ]]) {
          sh """
            aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER}
            kubectl get nodes
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-creds'
        ]]) {
        sh """
          kubectl apply -f k8s/app-deployment.yaml
          kubectl apply -f k8s/app-service.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.1/deploy/static/provider/aws/deploy.yaml
          kubectl get pods -n ingress-nginx
          kubectl apply -f k8s/app-ingress.yaml
          kubectl get svc -n ingress-nginx
          kubectl get ingress

        """
      }
     }
    }
  }

  post {
    success { echo "üéâ Deployment successful ‚Äî pictogram running (image: my-pictogram-app:${version})" }
    failure { echo "‚ùå Pipeline failed ‚Äî check logs." }
    always  { echo "Pipeline finished for build ${env.BUILD_NUMBER}" }
  }
}
